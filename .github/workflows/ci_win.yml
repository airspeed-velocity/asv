name: Windows CI

on: [push, pull_request]

jobs:
  test:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.7]

    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v2  # Use version 2 instead of 3 because at the time of my last update, v2 was the most stable.

    - name: Setup Micromamba ${{ matrix.python-version }}
      uses: mamba-org/setup-micromamba@v1
      with:
        environment-name: TEST
        init-shell: pwsh
        create-args: >-
          python=${{ matrix.python-version }}
          --channel conda-forge


    - name: Clear temp directory
      shell: pwsh
      run: |
        Remove-Item -Recurse -Force "$env:GITHUB_WORKSPACE\tmp" -ErrorAction SilentlyContinue

    - name: Setup a browser for more tests
      uses: browser-actions/setup-chrome@latest

    - name: Check Python version
      run: python --version

    - name: Install package
      shell: pwsh
      run: python -m pip install .

    - name: Run tests
      shell: pwsh
      run: |
        micromamba install libmambapy mamba
        python -m pytest -v -l --basetemp="$env:GITHUB_WORKSPACE\tmp" --timeout=300 --webdriver=ChromeHeadless --durations=100 test --environment-type=mamba
